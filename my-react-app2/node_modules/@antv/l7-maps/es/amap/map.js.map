{"version":3,"sources":["../../src/amap/map.ts"],"names":["AMapLoader","CoordinateSystem","MapServiceEvent","TYPES","DOM","mat4","vec3","inject","injectable","toPaddingOptions","Version","MapTheme","Viewport","mapdivCount","window","forceWebGL","AMAP_API_KEY","AMAP_VERSION","AMAP_SCRIPT_ID","amapLoaded","pendingResolveQueue","LNGLAT_OFFSET_ZOOM_THRESHOLD","AMapService","IGlobalConfigService","ILogService","MapConfig","ICoordinateSystemService","IEventEmitter","e","camera","fov","near","far","height","pitch","rotation","aspect","position","getCenter","lng","lat","cameraChangedCallback","viewport","syncWithMapCamera","bearing","cameraHeight","zoom","map","getZoom","center","offsetOrigin","x","y","config","offsetZoom","coordinateSystemService","setCoordinateSystem","P20_OFFSET","P20","mapContainer","getContainer","amap","getElementsByClassName","markerContainer","create","type","handler","indexOf","eventEmitter","on","off","size","getSize","getWidth","getHeight","setZoom","options","padding","originCenter","w","h","px","lngLatToPixel","offsetPx","right","left","bottom","top","newCenter","pixelToLngLat","getLng","getLat","lnglat","setCenter","getPitch","getRotation","amapBound","getBounds","toBounds","NE","getNorthEast","SW","getSouthWest","maxlng","minlng","zooms","get","setRotation","setPitch","zoomIn","zoomOut","p","panTo","pixel","extent","setBounds","AMap","Bounds","setZoomAndCenter","style","setMapStyle","getMapStyle","option","setStatus","lngLat","Pixel","lnglatToPixel","LngLat","getX","getY","ll","containerToLngLat","lngLatToContainer","altitude","z","rotate","scale","origin","flat","projectFlat","modelMatrix","translate","fromValues","rotateX","rotateY","rotateZ","id","minZoom","maxZoom","token","mapInstance","plugin","rest","Promise","resolve","resolveMap","$mapContainer","setTimeout","handleCameraChanged","creatAmapContainer","Map","mapStyle","viewMode","logger","warn","configService","getSceneWarninfo","push","load","key","version","plugins","then","length","forEach","r","catch","Error","renderCanvas","layersPng","toDataURL","name","args","emit","once","destroy","initAMap","$jsapi","document","getElementById","head","removeChild","callback","$wrapper","$amapdiv","createElement","cssText","appendChild"],"mappings":"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","sourcesContent":["/**\n * AMapService\n */\nimport AMapLoader from '@amap/amap-jsapi-loader';\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICameraOptions,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  ILogService,\n  IMapConfig,\n  IMapService,\n  IMercator,\n  IPoint,\n  IStatusOptions,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  TYPES,\n} from '@antv/l7-core';\nimport { DOM } from '@antv/l7-utils';\nimport { mat4, vec2, vec3 } from 'gl-matrix';\nimport { inject, injectable } from 'inversify';\nimport { IAMapEvent, IAMapInstance } from '../../typings/index';\nimport { toPaddingOptions } from '../utils';\nimport { Version } from '../version';\nimport './logo.css';\nimport { MapTheme } from './theme';\nimport Viewport from './Viewport';\nlet mapdivCount = 0;\n// @ts-ignore\nwindow.forceWebGL = true;\n\nconst AMAP_API_KEY: string = '15cd8a57710d40c9b7c0e3cc120f1200';\nconst AMAP_VERSION: string = '1.4.15';\n/**\n * 确保多个场景只引入一个高德地图脚本\n */\nconst AMAP_SCRIPT_ID: string = 'amap-script';\n/**\n * 高德地图脚本是否加载完毕\n */\nlet amapLoaded = false;\n/**\n * 高德地图脚本加载成功等待队列，成功之后依次触发\n */\nlet pendingResolveQueue: Array<() => void> = [];\nconst LNGLAT_OFFSET_ZOOM_THRESHOLD = 12; // 暂时关闭 fix 统一不同坐标系，不同底图的高度位置\n\n/**\n * AMapService\n */\n@injectable()\nexport default class AMapService\n  implements IMapService<AMap.Map & IAMapInstance> {\n  public version: string = Version['GAODE1.x'];\n  /**\n   * 原始地图实例\n   */\n  public map: AMap.Map & IAMapInstance;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.ILogService)\n  private readonly logger: ILogService;\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n\n  private markerContainer: HTMLElement;\n  private $mapContainer: HTMLElement | null;\n\n  private viewport: Viewport;\n\n  private cameraChangedCallback: (viewport: IViewport) => void;\n\n  public addMarkerContainer(): void {\n    const mapContainer = this.map.getContainer();\n    if (mapContainer !== null) {\n      const amap = mapContainer.getElementsByClassName(\n        'amap-maps',\n      )[0] as HTMLElement;\n      this.markerContainer = DOM.create('div', 'l7-marker-container', amap);\n    }\n  }\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handler);\n    } else {\n      this.map.on(type, handler);\n    }\n  }\n  public off(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.off(type, handler);\n    } else {\n      this.map.off(type, handler);\n    }\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getMapCanvasContainer(): HTMLElement {\n    return this.map\n      .getContainer()\n      ?.getElementsByClassName('amap-maps')[0] as HTMLElement;\n  }\n\n  public getSize(): [number, number] {\n    const size = this.map.getSize();\n    return [size.getWidth(), size.getHeight()];\n  }\n\n  public getType() {\n    return 'amap';\n  }\n  public getZoom(): number {\n    // 统一返回 Mapbox 缩放等级\n    return this.map.getZoom() - 1;\n  }\n\n  public setZoom(zoom: number): void {\n    return this.map.setZoom(zoom);\n  }\n\n  public getCenter(options?: ICameraOptions): ILngLat {\n    if (options?.padding) {\n      const originCenter = this.getCenter();\n      const [w, h] = this.getSize();\n      const padding = toPaddingOptions(options.padding);\n      const px = this.lngLatToPixel([originCenter.lng, originCenter.lat]);\n      const offsetPx = [\n        (padding.right - padding.left) / 2,\n        (padding.bottom - padding.top) / 2,\n      ];\n\n      const newCenter = this.pixelToLngLat([\n        px.x - offsetPx[0],\n        px.y - offsetPx[1],\n      ]);\n      return newCenter;\n    }\n    const center = this.map.getCenter();\n    return {\n      lng: center.getLng(),\n      lat: center.getLat(),\n    };\n  }\n  public setCenter(lnglat: [number, number], options?: ICameraOptions): void {\n    if (options?.padding) {\n      const padding = toPaddingOptions(options.padding);\n      const px = this.lngLatToPixel(lnglat);\n      const offsetPx = [\n        (padding.right - padding.left) / 2,\n        (padding.bottom - padding.top) / 2,\n      ];\n      const newCenter = this.pixelToLngLat([\n        px.x + offsetPx[0],\n        px.y + offsetPx[1],\n      ]);\n      this.map.setCenter([newCenter.lng, newCenter.lat]);\n    } else {\n      this.map.setCenter(lnglat);\n    }\n  }\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    // 统一返回逆时针旋转角度\n    return 360 - this.map.getRotation();\n  }\n\n  public getBounds(): Bounds {\n    // @ts-ignore\n    const amapBound = this.map.getBounds().toBounds();\n    const NE = amapBound.getNorthEast();\n    const SW = amapBound.getSouthWest();\n    const center = this.getCenter();\n    const maxlng =\n      center.lng > NE.getLng() || center.lng < SW.getLng()\n        ? 180 - NE.getLng()\n        : NE.getLng();\n    const minlng = center.lng < SW.getLng() ? SW.getLng() - 180 : SW.getLng();\n    // 兼容 Mapbox，统一返回西南、东北\n    return [\n      [minlng, SW.getLat()],\n      [maxlng, NE.getLat()],\n    ];\n  }\n\n  public getMinZoom(): number {\n    const zooms = this.map.get('zooms') as [number, number];\n    return zooms[0] - 1;\n  }\n  public getMaxZoom(): number {\n    const zooms = this.map.get('zooms') as [number, number];\n    return zooms[1] - 1;\n  }\n  public setRotation(rotation: number): void {\n    return this.map.setRotation(rotation);\n  }\n\n  public setPitch(pitch: number) {\n    return this.map.setPitch(pitch);\n  }\n  public zoomIn(): void {\n    this.map.zoomIn();\n  }\n\n  public zoomOut(): void {\n    this.map.zoomOut();\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n  public panBy(pixel: [number, number]): void {\n    this.map.panTo(pixel);\n  }\n  public fitBounds(extent: Bounds): void {\n    this.map.setBounds(\n      new AMap.Bounds([extent[0][0], extent[0][1], extent[1][0], extent[1][1]]),\n    );\n  }\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.setZoomAndCenter(zoom, center);\n  }\n  public setMapStyle(style: string): void {\n    this.map.setMapStyle(this.getMapStyle(style));\n  }\n\n  public setMapStatus(option: Partial<IStatusOptions>): void {\n    this.map.setStatus(option);\n  }\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    const lngLat = this.map.pixelToLngLat(new AMap.Pixel(pixel[0], pixel[1]));\n    return { lng: lngLat.getLng(), lat: lngLat.getLat() };\n  }\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    const p = this.map.lnglatToPixel(new AMap.LngLat(lnglat[0], lnglat[1]));\n    return {\n      x: p.getX(),\n      y: p.getY(),\n    };\n  }\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    const ll = new AMap.Pixel(pixel[0], pixel[1]);\n    const lngLat = this.map.containerToLngLat(ll);\n    return {\n      lng: lngLat?.getLng(),\n      lat: lngLat?.getLat(),\n    };\n  }\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    const ll = new AMap.LngLat(lnglat[0], lnglat[1]);\n    const pixel = this.map.lngLatToContainer(ll);\n    return {\n      x: pixel.getX(),\n      y: pixel.getY(),\n    };\n  }\n\n  public lngLatToMercator(\n    lnglat: [number, number],\n    altitude: number,\n  ): IMercator {\n    return {\n      x: 0,\n      y: 0,\n      z: 0,\n    };\n  }\n\n  public getModelMatrix(\n    lnglat: [number, number],\n    altitude: number,\n    rotate: [number, number, number],\n    scale: [number, number, number] = [1, 1, 1],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ): number[] {\n    const flat = this.viewport.projectFlat(lnglat);\n    // @ts-ignore\n    const modelMatrix = mat4.create();\n\n    mat4.translate(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(flat[0], flat[1], altitude),\n    );\n    mat4.scale(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(scale[0], scale[1], scale[2]),\n    );\n\n    mat4.rotateX(modelMatrix, modelMatrix, rotate[0]);\n    mat4.rotateY(modelMatrix, modelMatrix, rotate[1]);\n    mat4.rotateZ(modelMatrix, modelMatrix, rotate[2]);\n\n    return (modelMatrix as unknown) as number[];\n  }\n  public async init(): Promise<void> {\n    const {\n      id,\n      style = 'light',\n      minZoom = 0,\n      maxZoom = 18,\n      token = AMAP_API_KEY,\n      mapInstance,\n      plugin = [],\n      ...rest\n    } = this.config;\n    // 高德地图创建独立的container；\n    // tslint:disable-next-line:typedef\n    await new Promise<void>((resolve) => {\n      const resolveMap = () => {\n        if (mapInstance) {\n          this.map = mapInstance as AMap.Map & IAMapInstance;\n          this.$mapContainer = this.map.getContainer();\n          setTimeout(() => {\n            this.map.on('camerachange', this.handleCameraChanged);\n            resolve();\n          }, 30);\n        } else {\n          this.$mapContainer = this.creatAmapContainer(\n            id as string | HTMLDivElement,\n          );\n\n          const map = new AMap.Map(this.$mapContainer, {\n            mapStyle: this.getMapStyle(style as string),\n            zooms: [minZoom, maxZoom],\n            viewMode: '3D',\n            ...rest,\n          });\n          // 监听地图相机事件\n          map.on('camerachange', this.handleCameraChanged);\n          // @ts-ignore\n          this.map = map;\n          setTimeout(() => {\n            resolve();\n          }, 10);\n        }\n      };\n      if (!amapLoaded && !mapInstance) {\n        if (token === AMAP_API_KEY) {\n          this.logger.warn(this.configService.getSceneWarninfo('MapToken'));\n        }\n        amapLoaded = true;\n        plugin.push('Map3D');\n        AMapLoader.load({\n          key: token, // 申请好的Web端开发者Key，首次调用 load 时必填\n          version: AMAP_VERSION, // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15\n          plugins: plugin, // 需要使用的的插件列表，如比例尺'AMap.Scale'等\n        })\n          .then((AMap) => {\n            resolveMap();\n\n            if (pendingResolveQueue.length) {\n              pendingResolveQueue.forEach((r) => r());\n              pendingResolveQueue = [];\n            }\n          })\n          .catch((e) => {\n            throw new Error(e);\n          });\n      } else {\n        if ((amapLoaded && window.AMap) || mapInstance) {\n          resolveMap();\n        } else {\n          pendingResolveQueue.push(resolveMap);\n        }\n      }\n    });\n\n    this.viewport = new Viewport();\n  }\n\n  public exportMap(type: 'jpg' | 'png'): string {\n    const renderCanvas = this.getContainer()?.getElementsByClassName(\n      'amap-layer',\n    )[0] as HTMLCanvasElement;\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public destroy() {\n    this.map.destroy();\n    // @ts-ignore\n    delete window.initAMap;\n    const $jsapi = document.getElementById(AMAP_SCRIPT_ID);\n    if ($jsapi) {\n      document.head.removeChild($jsapi);\n    }\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  private handleCameraChanged = (e: IAMapEvent): void => {\n    const {\n      fov,\n      near,\n      far,\n      height,\n      pitch,\n      rotation,\n      aspect,\n      position,\n    } = e.camera;\n    const { lng, lat } = this.getCenter();\n    if (this.cameraChangedCallback) {\n      // resync viewport\n      // console.log('cameraHeight', height)\n      // console.log('pitch', pitch)\n      // console.log('rotation', rotation)\n      // console.log('zoom', this.map.getZoom())\n      this.viewport.syncWithMapCamera({\n        aspect,\n        // AMap 定义 rotation 为顺时针方向，而 Mapbox 为逆时针\n        // @see https://docs.mapbox.com/mapbox-gl-js/api/#map#getbearing\n        bearing: 360 - rotation,\n        far,\n        fov,\n        cameraHeight: height,\n        near,\n        pitch,\n        // AMap 定义的缩放等级 与 Mapbox 相差 1\n        zoom: this.map.getZoom() - 1,\n        center: [lng, lat],\n        offsetOrigin: [position.x, position.y],\n      });\n      const { offsetZoom = LNGLAT_OFFSET_ZOOM_THRESHOLD } = this.config;\n      // console.log('this.viewport', this.viewport)\n      // set coordinate system\n      if (this.viewport.getZoom() > offsetZoom) {\n        this.coordinateSystemService.setCoordinateSystem(\n          CoordinateSystem.P20_OFFSET,\n        );\n      } else {\n        this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.P20);\n      }\n      this.cameraChangedCallback(this.viewport);\n    }\n  };\n\n  private getMapStyle(name: string): string {\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    const $amapdiv = document.createElement('div');\n    $amapdiv.style.cssText += `\n      position: absolute;\n      top: 0;\n      height: 100%;\n      width: 100%;\n    `;\n    $amapdiv.id = 'l7_amap_div' + mapdivCount++;\n    $wrapper.appendChild($amapdiv);\n    return $amapdiv;\n  }\n}\n"],"file":"map.js"}